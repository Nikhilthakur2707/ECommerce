<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Decorify ‚Äî Home Decor Marketplace</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#f97316;--glass:rgba(255,255,255,0.03);--max-w:1200px;font-family:Inter,system-ui,sans-serif}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(180deg,#071028,#07182a 60%);color:#e6eef8;min-height:100vh;padding:20px}
    .site{max-width:var(--max-w);margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,#fff,var(--accent));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#0b1220;font-weight:700;font-size:24px}
    h1{font-size:20px}
    .search{flex:1;margin:0 20px;min-width:200px}
    .search input{width:100%;padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .controls{display:flex;gap:10px}
    .btn{padding:10px 16px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#ffb86b);color:#08111b;font-weight:700;cursor:pointer;transition:all 0.2s}
    .btn:hover{transform:scale(1.05)}
    button.icon{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:10px 16px;border-radius:10px;color:var(--muted);cursor:pointer;transition:all 0.2s}
    button.icon:hover{background:rgba(255,255,255,0.06);color:white}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);margin-bottom:20px}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .product{padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02);transition:all 0.3s}
    .product:hover{border-color:rgba(255,255,255,0.1);transform:translateY(-2px)}
    .product img{width:100%;height:150px;object-fit:cover;border-radius:8px;margin-bottom:10px}
    .product .title{font-weight:600;font-size:15px;margin-bottom:5px}
    .price-row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .tag{background:rgba(34,197,94,0.15);padding:4px 8px;border-radius:999px;font-size:11px;color:#4ade80;font-weight:600}
    .cart{position:fixed;right:20px;bottom:20px;background:linear-gradient(180deg,#081424,#06111a);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);min-width:320px;max-width:400px;z-index:30;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    .cart .items{max-height:300px;overflow-y:auto;margin:12px 0}
    .cart-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.06)}
    .cart-item img{width:56px;height:56px;object-fit:cover;border-radius:8px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:24px;z-index:100}
    .modal-backdrop.open{display:flex}
    .modal{background:#0b1220;border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:32px;max-width:500px;width:100%;position:relative}
    .close-x{position:absolute;top:16px;right:16px;background:transparent;border:0;color:#fff;font-size:28px;cursor:pointer}
    .auth-form{display:flex;flex-direction:column;gap:16px;margin-top:20px}
    .auth-form input{padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white}
    .order-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);margin-bottom:16px}
    .loading{text-align:center;padding:60px 20px;color:var(--muted)}
    @media (max-width:900px){
      .products-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
      .cart{left:20px;right:20px;bottom:20px}
      header{flex-direction:column;align-items:stretch}
      .search{margin:0;width:100%}
      .controls{justify-content:center;flex-wrap:wrap}
      .checkout-grid{grid-template-columns:1fr !important}
    }
    @media (max-width:768px){
      body{padding:12px}
      .card{padding:16px}
      .logo{width:40px;height:40px;font-size:20px}
      h1{font-size:18px}
      button.icon{padding:8px 12px;font-size:13px}
    }
  </style>
</head>
<body>
  <div class="site">
    <header>
      <div class="brand" onclick="navigateTo('home')">
        <div class="logo">D</div>
        <div><h1>Decorify</h1><div style="font-size:12px;color:var(--muted)">Home Decor Platform</div></div>
      </div>
      <div class="search"><input id="search" placeholder="Search products..."/></div>
      <div class="controls">
        <button class="icon" onclick="navigateTo('shop')">Shop</button>
        <button class="icon" id="wishlistBtn" style="display:none" onclick="navigateTo('wishlist')">‚ù§Ô∏è <span id="wishlistCount">0</span></button>
        <button class="icon" onclick="toggleCart()">üõí <span id="cartCount">0</span></button>
        <button class="icon" id="authBtn" onclick="showAuth()">Sign In</button>
        <button class="icon" id="profileBtn" style="display:none" onclick="navigateTo('profile')">üë§</button>
      </div>
    </header>
    <div id="mainContent"><div class="loading">Loading...</div></div>
    <div class="cart" id="cartPanel" style="display:none">
      <div style="display:flex;justify-content:space-between;margin-bottom:12px">
        <div style="font-weight:700">Cart</div>
        <button onclick="toggleCart()" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:20px">√ó</button>
      </div>
      <div class="items" id="cartItems"></div>
      <div style="border-top:2px solid rgba(255,255,255,0.06);padding-top:12px;margin-top:12px">
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span style="font-weight:700">Total:</span>
          <span style="font-weight:700">‚Çπ<span id="cartTotal">0</span></span>
        </div>
        <button class="btn" onclick="navigateTo('checkout')" style="width:100%">Checkout</button>
      </div>
    </div>
    <div class="modal-backdrop" id="authModal">
      <div class="modal">
        <button class="close-x" onclick="closeAuthModal()">√ó</button>
        <h2 id="authTitle" style="text-align:center">Welcome</h2>
        <form class="auth-form" id="authForm">
          <div id="nameField" style="display:none"><input type="text" id="authName" placeholder="Full Name"/></div>
          <input type="email" id="authEmail" placeholder="Email" required/>
          <input type="password" id="authPassword" placeholder="Password (min 6 characters)" required minlength="6"/>
          <button type="submit" class="btn" style="padding:14px">Continue</button>
        </form>
        <div style="text-align:center;margin-top:16px;color:var(--muted)">
          <span id="authToggleText"></span>
          <a onclick="toggleAuthMode()" style="color:var(--accent);cursor:pointer;text-decoration:underline" id="authToggleLink"></a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let PRODUCTS = [];
    
    // Initialize state with default values
    let state = {
      currentPage: 'home',
      user: null,
      cart: {},
      wishlist: new Set(),
      orders: [],
      authMode: 'login',
      filters: {
        categories: new Set(),
        minPrice: null,
        maxPrice: null,
        q: ''
      }
    };

    const $ = id => document.getElementById(id);
    const formatINR = n => n ? n.toLocaleString('en-IN') : '0';

    const apiCall = async (endpoint, options = {}) => {
      try {
        const token = localStorage.getItem('decorifyToken');
        const headers = {'Content-Type': 'application/json', ...options.headers};
        if (token && !options.skipAuth) {
          headers.Authorization = `Bearer ${token}`;
          headers['x-auth-token'] = token;
        }
        const response = await fetch(`${API_URL}${endpoint}`, {...options, headers});
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || data.msg || 'Request failed');
        return data;
      } catch (error) {
        console.error('API Error:', error);
        showNotification(error.message, 'error');
        throw error;
      }
    };

    const fetchProducts = async () => {
      try {
        console.log('Fetching products from:', API_URL + '/products');
        const data = await apiCall('/products');
        console.log('Products received:', data);
        
        if (data && data.products && Array.isArray(data.products)) {
          PRODUCTS = data.products.map(p => ({
            id: p._id,
            title: p.title,
            price: p.price,
            category: p.category,
            rating: p.rating || 4.5,
            reviews: p.reviews || 0,
            img: p.image,
            desc: p.description
          }));
          console.log('‚úÖ Loaded', PRODUCTS.length, 'products');
          return PRODUCTS;
        } else {
          throw new Error('Invalid products data received');
        }
      } catch (error) {
        console.error('‚ùå Failed to fetch products:', error);
        showNotification('Failed to load products. Check if backend is running.', 'error');
        return [];
      }
    };

    function loadState() {
      const token = localStorage.getItem('decorifyToken');
      const savedUser = localStorage.getItem('decorifyUser');
      if (token && savedUser) {
        try {
          state.user = JSON.parse(savedUser);
          syncUserData();
        } catch (e) {
          console.error('Error loading user:', e);
        }
      }
      updateAuthUI();
    }

    async function syncUserData() {
      if (!state.user) return;
      try {
        const cartData = await apiCall('/cart');
        if (cartData && cartData.success && cartData.cart) {
          state.cart = {};
          cartData.cart.forEach(item => {
            if (item.product && item.product._id) {
              state.cart[item.product._id] = item.quantity;
            }
          });
        }
        
        const wishlistData = await apiCall('/wishlist');
        if (wishlistData && wishlistData.success && wishlistData.wishlist) {
          state.wishlist = new Set(wishlistData.wishlist.map(p => p._id));
        }
        
        const ordersData = await apiCall('/orders/history');
        if (ordersData && Array.isArray(ordersData)) {
          state.orders = ordersData;
        }
        
        updateCartUI();
        updateWishlistUI();
      } catch (error) {
        console.error('Sync error:', error);
      }
    }

    function navigateTo(page) {
      if (page !== 'home' && page !== 'shop' && !state.user) {
        showAuth();
        return;
      }
      state.currentPage = page;
      renderPage();
      window.scrollTo(0, 0);
    }

    function renderPage() {
      const content = $('mainContent');
      if (!content) return;
      
      switch(state.currentPage) {
        case 'home': content.innerHTML = getHomePage(); break;
        case 'shop': content.innerHTML = getShopPage(); break;
        case 'profile': content.innerHTML = state.user ? getProfilePage() : getHomePage(); break;
        case 'wishlist': content.innerHTML = state.user ? getWishlistPage() : getHomePage(); break;
        case 'checkout': content.innerHTML = getCheckoutPage(); break;
        case 'orders': content.innerHTML = getOrdersPage(); break;
        default: content.innerHTML = getHomePage();
      }
      
      if (state.currentPage === 'shop' || state.currentPage === 'home') {
        const productsToShow = state.currentPage === 'home' ? PRODUCTS.slice(0, 8) : PRODUCTS;
        renderProducts(productsToShow);
      }
    }

    function getHomePage() {
      return `
        <div class="card" style="background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.0));padding:40px">
          <h2 style="font-size:32px;margin-bottom:12px">Bring your space to life</h2>
          <p style="color:var(--muted);margin-bottom:20px;font-size:18px">Curated handpicked home decor ‚Äî sustainable, stylish, and affordable.</p>
          <button class="btn" onclick="navigateTo('shop')" style="padding:14px 24px;font-size:16px">Shop Now</button>
        </div>
        <div class="card">
          <h3 style="margin-bottom:16px;font-size:22px">Featured Products</h3>
          <div class="products-grid" id="products"></div>
        </div>
      `;
    }

    function getShopPage() {
      return `
        <div class="card">
          <h3 style="margin-bottom:16px">All Products (${PRODUCTS.length})</h3>
          <div class="products-grid" id="products"></div>
        </div>
      `;
    }

    function getProfilePage() {
      if (!state.user) return getHomePage();
      const cartCount = Object.values(state.cart).reduce((a,b)=>a+b,0);
      return `
        <div style="max-width:800px;margin:0 auto">
          <div class="card" style="background:linear-gradient(135deg,rgba(249,115,22,0.1),rgba(251,191,107,0.1));padding:32px">
            <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
              <div style="width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#ffb86b);display:flex;align-items:center;justify-content:center;font-size:42px;font-weight:700;color:#08111b">${state.user.name.charAt(0).toUpperCase()}</div>
              <div style="flex:1">
                <h2>${state.user.name}</h2>
                <div style="color:var(--muted);margin-top:4px">${state.user.email}</div>
              </div>
              <button class="btn" onclick="logout()" style="background:linear-gradient(90deg,#ef4444,#dc2626)">Logout</button>
            </div>
          </div>
          <div class="card">
            <h3 style="margin-bottom:16px">Quick Actions</h3>
            <div style="display:grid;gap:12px">
              <button class="btn" onclick="navigateTo('shop')" style="padding:14px;text-align:left">üõçÔ∏è Continue Shopping</button>
              <button class="btn" onclick="navigateTo('wishlist')" style="padding:14px;text-align:left;background:linear-gradient(90deg,#ec4899,#f472b6)">‚ù§Ô∏è Wishlist (${state.wishlist.size})</button>
              <button class="btn" onclick="toggleCart()" style="padding:14px;text-align:left;background:linear-gradient(90deg,#10b981,#34d399)">üõí View Cart (${cartCount})</button>
              <button class="btn" onclick="navigateTo('orders')" style="padding:14px;text-align:left;background:linear-gradient(90deg,#3b82f6,#60a5fa)">üì¶ Order History (${state.orders.length})</button>
            </div>
          </div>
        </div>
      `;
    }

    function getWishlistPage() {
      if (state.wishlist.size === 0) {
        return `
          <div class="card" style="text-align:center;padding:60px 20px">
            <div style="font-size:64px;margin-bottom:16px">‚ù§Ô∏è</div>
            <h2 style="margin-bottom:8px">Wishlist is empty</h2>
            <p style="color:var(--muted);margin-bottom:24px">Start adding products you love!</p>
            <button class="btn" onclick="navigateTo('shop')">Discover Products</button>
          </div>
        `;
      }
      const wishlistItems = Array.from(state.wishlist).map(id => PRODUCTS.find(p => p.id === id)).filter(Boolean);
      return `
        <div class="card">
          <h2 style="margin-bottom:20px">My Wishlist (${state.wishlist.size})</h2>
          <div class="products-grid" id="wishlistGrid">
            ${wishlistItems.map(p => `
              <div class="product">
                <div style="position:relative">
                  <img src="${p.img}" alt="${p.title}">
                  <button onclick="toggleWishlist('${p.id}')" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);border:none;color:#ef4444;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px">√ó</button>
                </div>
                <div class="title">${p.title}</div>
                <div style="color:var(--muted);font-size:13px">${p.category}</div>
                <div class="price-row">
                  <div style="font-weight:800">‚Çπ${formatINR(p.price)}</div>
                  <div class="tag">Free delivery</div>
                </div>
                <button class="btn" onclick="addToCart('${p.id}')" style="width:100%">Add to Cart</button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function getCheckoutPage() {
      if (Object.keys(state.cart).length === 0) {
        return `
          <div class="card" style="text-align:center;padding:60px 20px">
            <div style="font-size:64px;margin-bottom:16px">üõí</div>
            <h2 style="margin-bottom:8px">Cart is empty</h2>
            <button class="btn" onclick="navigateTo('shop')">Start Shopping</button>
          </div>
        `;
      }
      let cartItems = [];
      let total = 0;
      Object.keys(state.cart).forEach(id => {
        const p = PRODUCTS.find(x => x.id == id);
        if (p) {
          cartItems.push({...p, quantity: state.cart[id]});
          total += p.price * state.cart[id];
        }
      });
      return `
        <div style="max-width:900px;margin:0 auto">
          <h2 style="margin-bottom:24px">Checkout</h2>
          
          <div style="display:grid;grid-template-columns:1fr 400px;gap:24px" class="checkout-grid">
            <div>
              <form onsubmit="handleCheckout(event)" id="checkoutForm">
                <div class="card">
                  <h3 style="margin-bottom:16px">üìç Shipping Address</h3>
                  <div style="display:grid;gap:12px">
                    <input type="text" name="fullName" placeholder="Full Name" required style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white"/>
                    <input type="email" name="email" placeholder="Email" required value="${state.user?.email || ''}" style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white"/>
                    <input type="tel" name="phone" placeholder="Phone Number" required style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white"/>
                    <textarea name="address" placeholder="Full Address" required rows="2" style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white;font-family:inherit"></textarea>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                      <input type="text" name="city" placeholder="City" required style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white"/>
                      <input type="text" name="pincode" placeholder="Pincode" required pattern="[0-9]{6}" style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white"/>
                    </div>
                  </div>
                </div>

                <div class="card" style="margin-top:20px">
                  <h3 style="margin-bottom:16px">üí≥ Payment Information</h3>
                  <div style="display:grid;gap:12px">
                    <div>
                      <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--muted)">Card Number</label>
                      <input type="text" name="cardNumber" placeholder="1234 5678 9012 3456" required maxlength="19" pattern="[0-9 ]{16,19}" value="4242 4242 4242 4242" style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white;width:100%;font-family:monospace"/>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                      <div>
                        <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--muted)">Expiry Date</label>
                        <input type="text" name="expiry" placeholder="MM/YY" required maxlength="5" pattern="[0-9]{2}/[0-9]{2}" value="12/28" style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white;width:100%;font-family:monospace"/>
                      </div>
                      <div>
                        <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--muted)">CVV</label>
                        <input type="text" name="cvv" placeholder="123" required maxlength="3" pattern="[0-9]{3}" value="123" style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white;width:100%;font-family:monospace"/>
                      </div>
                    </div>
                    <div>
                      <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--muted)">Cardholder Name</label>
                      <input type="text" name="cardName" placeholder="Name on Card" required style="padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.02);color:white;width:100%"/>
                    </div>
                  </div>
                  <div style="margin-top:16px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px;border:1px solid rgba(59,130,246,0.2)">
                    <div style="color:#60a5fa;font-size:12px;line-height:1.6">
                      üîí <strong>Demo Payment Mode</strong><br>
                      Use the pre-filled card details for testing. No real payment will be processed. This is a demonstration checkout for educational purposes.
                    </div>
                  </div>
                </div>
              </form>
            </div>

            <div>
              <div class="card" style="position:sticky;top:20px">
                <h3 style="margin-bottom:16px">Order Summary</h3>
                <div style="max-height:300px;overflow-y:auto;margin-bottom:16px">
                  ${cartItems.map(item => `
                    <div style="display:flex;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.06)">
                      <img src="${item.img}" style="width:60px;height:60px;object-fit:cover;border-radius:8px"/>
                      <div style="flex:1">
                        <div style="font-weight:600;font-size:14px">${item.title}</div>
                        <div style="color:var(--muted);font-size:12px">Qty: ${item.quantity}</div>
                        <div style="font-weight:700;margin-top:4px">‚Çπ${formatINR(item.price * item.quantity)}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                <div style="border-top:2px solid rgba(255,255,255,0.06);padding-top:16px;margin-bottom:16px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                    <span style="color:var(--muted)">Subtotal</span>
                    <span style="font-weight:600">‚Çπ${formatINR(total)}</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                    <span style="color:var(--muted)">Shipping</span>
                    <span style="font-weight:600;color:#4ade80">FREE</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                    <span style="color:var(--muted)">Tax</span>
                    <span style="font-weight:600">‚Çπ0</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;font-size:20px;font-weight:800;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06)">
                    <span>Total</span>
                    <span style="color:var(--accent)">‚Çπ${formatINR(total)}</span>
                  </div>
                </div>
                <button type="submit" form="checkoutForm" class="btn" style="width:100%;padding:16px;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px">
                  <span>üîí</span>
                  <span>Place Order - ‚Çπ${formatINR(total)}</span>
                </button>
                <div style="margin-top:12px;text-align:center;font-size:11px;color:var(--muted)">
                  By placing this order, you agree to our Terms of Service
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function getOrdersPage() {
      if (!state.orders || state.orders.length === 0) {
        return `
          <div class="card" style="text-align:center;padding:60px 20px">
            <div style="font-size:64px;margin-bottom:16px">üì¶</div>
            <h2 style="margin-bottom:8px">No orders yet</h2>
            <button class="btn" onclick="navigateTo('shop')">Start Shopping</button>
          </div>
        `;
      }
      return `
        <div style="max-width:800px;margin:0 auto">
          <h2 style="margin-bottom:24px">Order History (${state.orders.length})</h2>
          ${state.orders.map(order => {
            const items = order.products || order.items || [];
            const orderTotal = items.reduce((sum, item) => {
              const product = PRODUCTS.find(p => p.id === (item.productId || (item.product && item.product._id)));
              return sum + ((item.price || (product && product.price) || 0) * item.quantity);
            }, 0);
            
            return `
              <div class="order-card">
                <div style="display:flex;justify-content:space-between;margin-bottom:16px">
                  <div>
                    <div style="font-weight:700">Order #${order._id.slice(-8).toUpperCase()}</div>
                    <div style="color:var(--muted);font-size:12px">${new Date(order.date || order.createdAt).toLocaleDateString()}</div>
                  </div>
                  <span style="background:rgba(34,197,94,0.15);color:#4ade80;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600">${order.status || 'Placed'}</span>
                </div>
                <div style="border-top:1px solid rgba(255,255,255,0.06);padding-top:12px">
                  ${items.map(item => {
                    const product = PRODUCTS.find(p => p.id === (item.productId || (item.product && item.product._id)));
                    return product ? `
                      <div style="display:flex;gap:12px;margin-bottom:8px">
                        <img src="${product.img}" style="width:48px;height:48px;object-fit:cover;border-radius:6px"/>
                        <div style="flex:1">
                          <div style="font-weight:600;font-size:14px">${product.title}</div>
                          <div style="color:var(--muted);font-size:12px">Qty: ${item.quantity}</div>
                        </div>
                        <div style="font-weight:700">‚Çπ${formatINR((item.price || product.price) * item.quantity)}</div>
                      </div>
                    ` : '';
                  }).join('')}
                </div>
                <div style="border-top:1px solid rgba(255,255,255,0.06);padding-top:12px;margin-top:12px;text-align:right">
                  <span style="font-weight:800;font-size:18px">Total: ‚Çπ${formatINR(orderTotal)}</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderProducts(list) {
      const container = $('products');
      if (!container) return;
      
      if (!list || list.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No products available</div>';
        return;
      }
      
      container.innerHTML = '';
      list.forEach(p => {
        const el = document.createElement('div');
        el.className = 'product';
        const inWishlist = state.wishlist.has(p.id);
        const inCart = state.cart[p.id];
        el.innerHTML = `
          <div style="position:relative">
            <img src="${p.img}" alt="${p.title}">
            ${state.user ? `<button onclick="toggleWishlist('${p.id}')" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);border:none;color:${inWishlist ? '#ef4444' : '#fff'};width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px">‚ù§</button>` : ''}
          </div>
          <div class="title">${p.title}</div>
          <div style="color:var(--muted);font-size:13px">${p.category}</div>
          <div class="price-row">
            <div style="font-weight:800">‚Çπ${formatINR(p.price)}</div>
            <div class="tag">Free delivery</div>
          </div>
          <button class="btn" onclick="addToCart('${p.id}')" style="width:100%">${inCart ? '‚úì In Cart (' + inCart + ')' : 'Add to Cart'}</button>
        `;
        container.appendChild(el);
      });
    }

    async function addToCart(id) {
      if (!state.user) {
        showAuth();
        return;
      }
      try {
        await apiCall('/cart/add', {
          method: 'POST',
          body: JSON.stringify({ productId: id, quantity: 1 })
        });
        state.cart[id] = (state.cart[id] || 0) + 1;
        updateCartUI();
        const p = PRODUCTS.find(x => x.id === id);
        if (p) showNotification(`${p.title} added to cart!`);
        renderPage();
      } catch (error) {
        console.error('Add to cart error:', error);
      }
    }

    function updateCartUI() {
      const items = $('cartItems');
      if (!items) return;
      items.innerHTML = '';
      let total = 0, count = 0;
      const cartKeys = Object.keys(state.cart);
      
      if (cartKeys.length === 0) {
        items.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Cart is empty</div>';
      } else {
        cartKeys.forEach(id => {
          const qty = state.cart[id];
          const p = PRODUCTS.find(x => x.id == id);
          if (!p) return;
          total += p.price * qty;
          count += qty;
          const el = document.createElement('div');
          el.className = 'cart-item';
          el.innerHTML = `
            <img src="${p.img}"/>
            <div style="flex:1">
              <div style="font-weight:700;font-size:14px">${p.title}</div>
              <div style="color:var(--muted);font-size:12px">‚Çπ${formatINR(p.price)} √ó ${qty}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:4px">
              <button onclick="updateQuantity('${id}', 1)" style="padding:4px 8px;background:var(--glass);border:1px solid rgba(255,255,255,0.04);border-radius:6px;cursor:pointer;color:white">+</button>
              <button onclick="updateQuantity('${id}', -1)" style="padding:4px 8px;background:var(--glass);border:1px solid rgba(255,255,255,0.04);border-radius:6px;cursor:pointer;color:white">‚àí</button>
            </div>
          `;
          items.appendChild(el);
        });
      }
      $('cartTotal').innerText = formatINR(total);
      $('cartCount').innerText = count;
    }

    async function updateQuantity(id, change) {
      if (!state.cart[id]) return;
      const newQty = state.cart[id] + change;
      try {
        if (newQty <= 0) {
          await apiCall(`/cart/remove/${id}`, { method: 'DELETE' });
          delete state.cart[id];
        } else {
          await apiCall('/cart/update', {
            method: 'PUT',
            body: JSON.stringify({ productId: id, quantity: newQty })
          });
          state.cart[id] = newQty;
        }
        updateCartUI();
        renderPage();
      } catch (error) {
        console.error('Update quantity error:', error);
      }
    }

    function toggleCart() {
      const panel = $('cartPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') updateCartUI();
    }

    async function toggleWishlist(id) {
      if (!state.user) {
        showAuth();
        return;
      }
      try {
        const isInWishlist = state.wishlist.has(id);
        if (isInWishlist) {
          await apiCall(`/wishlist/remove/${id}`, { method: 'DELETE' });
          state.wishlist.delete(id);
          showNotification('Removed from wishlist');
        } else {
          await apiCall(`/wishlist/add/${id}`, { method: 'POST' });
          state.wishlist.add(id);
          showNotification('Added to wishlist ‚ù§Ô∏è');
        }
        updateWishlistUI();
        renderPage();
      } catch (error) {
        console.error('Wishlist error:', error);
      }
    }

    function updateWishlistUI() {
      $('wishlistCount').innerText = state.wishlist.size;
    }

    function showAuth() {
      state.authMode = 'login';
      updateAuthModal();
      $('authModal').classList.add('open');
    }

    function closeAuthModal() {
      $('authModal').classList.remove('open');
    }

    function toggleAuthMode() {
      state.authMode = state.authMode === 'login' ? 'signup' : 'login';
      updateAuthModal();
    }

    function updateAuthModal() {
      const isLogin = state.authMode === 'login';
      $('authTitle').innerText = isLogin ? 'Welcome Back' : 'Create Account';
      $('nameField').style.display = isLogin ? 'none' : 'block';
      $('authToggleText').innerText = isLogin ? "Don't have an account? " : "Already have an account? ";
      $('authToggleLink').innerText = isLogin ? 'Sign Up' : 'Sign In';
    }

    function updateAuthUI() {
      if (state.user) {
        $('authBtn').style.display = 'none';
        $('profileBtn').style.display = 'block';
        $('wishlistBtn').style.display = 'block';
      } else {
        $('authBtn').style.display = 'block';
        $('profileBtn').style.display = 'none';
        $('wishlistBtn').style.display = 'none';
      }
    }

    function logout() {
      state.user = null;
      state.cart = {};
      state.wishlist = new Set();
      state.orders = [];
      localStorage.removeItem('decorifyToken');
      localStorage.removeItem('decorifyUser');
      updateAuthUI();
      updateCartUI();
      updateWishlistUI();
      navigateTo('home');
      showNotification('Logged out successfully');
    }

    async function handleCheckout(e) {
      e.preventDefault();
      
      // Get the submit button safely
      const submitBtn = e.target.querySelector('button[type="submit"]');
      if (!submitBtn) {
        console.error('Submit button not found');
        return;
      }
      
      const originalText = submitBtn.innerHTML;
      const originalBg = submitBtn.style.background;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span style="display:inline-block;animation:spin 1s linear infinite">‚è≥</span> Processing Payment...';
      
      // Simulate payment processing delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const items = Object.keys(state.cart).map(productId => ({
        product: productId,
        productId: productId,
        quantity: state.cart[productId],
        price: PRODUCTS.find(p => p.id === productId)?.price || 0
      }));
      
      try {
        await apiCall('/orders', {
          method: 'POST',
          body: JSON.stringify({
            products: items,
            status: 'Placed'
          })
        });
        
        // Show success animation
        submitBtn.innerHTML = '‚úÖ Payment Successful!';
        submitBtn.style.background = 'linear-gradient(90deg, #10b981, #34d399)';
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        showNotification('üéâ Order placed successfully! Payment completed.');
        
        // Clear cart
        state.cart = {};
        
        try {
          await apiCall('/cart/clear', { method: 'DELETE' });
        } catch (e) {
          console.log('Cart clear error:', e);
        }
        
        await syncUserData();
        updateCartUI();
        
        // Redirect to orders page
        setTimeout(() => {
          navigateTo('orders');
        }, 1500);
        
      } catch (error) {
        console.error('Checkout error:', error);
        submitBtn.innerHTML = '‚ùå Payment Failed - Retry';
        submitBtn.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
        showNotification('Order placement failed. Please try again.', 'error');
        
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          submitBtn.style.background = originalBg;
        }, 3000);
      }
      
      // Add spin animation
      if (!document.getElementById('spinAnimation')) {
        const style = document.createElement('style');
        style.id = 'spinAnimation';
        style.textContent = '@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}';
        document.head.appendChild(style);
      }
    }

    $('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('authEmail').value;
      const password = $('authPassword').value;
      const name = $('authName').value || email.split('@')[0];
      try {
        const endpoint = state.authMode === 'login' ? '/auth/login' : '/auth/signup';
        const data = await apiCall(endpoint, {
          method: 'POST',
          body: JSON.stringify(state.authMode === 'login' ? { email, password } : { name, email, password }),
          skipAuth: true
        });
        if (data.success || data.token) {
          state.user = data.user;
          localStorage.setItem('decorifyToken', data.token);
          localStorage.setItem('decorifyUser', JSON.stringify(data.user));
          await syncUserData();
          updateAuthUI();
          closeAuthModal();
          showNotification(`Welcome, ${data.user.name}! üëã`);
          $('authEmail').value = '';
          $('authPassword').value = '';
          $('authName').value = '';
          renderPage();
        }
      } catch (error) {
        console.error('Auth error:', error);
      }
    });

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      const bgColor = type === 'error' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'linear-gradient(135deg, var(--accent), #ffb86b)';
      notification.style.cssText = `position:fixed;top:80px;right:20px;background:${bgColor};color:#fff;padding:16px 24px;border-radius:12px;font-weight:700;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:1000;max-width:400px;animation:slideIn 0.3s`;
      notification.innerText = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    $('search').addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      if (query) {
        const filtered = PRODUCTS.filter(p => 
          p.title.toLowerCase().includes(query) || 
          p.category.toLowerCase().includes(query)
        );
        if (state.currentPage === 'shop' || state.currentPage === 'home') {
          renderProducts(filtered);
        }
      } else {
        renderPage();
      }
    });

    $('authModal').addEventListener('click', (e) => {
      if (e.target === $('authModal')) closeAuthModal();
    });

    // Initialize application
    (async function init() {
      console.log('üöÄ Initializing Decorify...');
      
      // Load products first
      await fetchProducts();
      
      // Then load user state
      loadState();
      
      // Render initial page
      if (PRODUCTS.length > 0) {
        console.log('‚úÖ Products loaded successfully');
        navigateTo('home');
      } else {
        $('mainContent').innerHTML = `
          <div class="card" style="text-align:center;padding:60px 20px">
            <div style="font-size:64px;margin-bottom:16px">‚ö†Ô∏è</div>
            <h2 style="margin-bottom:8px;color:#ef4444">Backend Not Connected</h2>
            <p style="color:var(--muted);margin-bottom:24px">Make sure backend is running on http://localhost:5000</p>
            <button class="btn" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
      
      // Add animation styles
      const style = document.createElement('style');
      style.textContent = '@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}';
      document.head.appendChild(style);
      
      console.log('‚úÖ Decorify initialized');
    })();
  </script>
</body>
</html>